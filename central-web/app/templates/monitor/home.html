{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% import "monitor/utils.html" as utils %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('static', filename='monitor/home.css')}}">
{% endblock %}

{% block scripts %}
{{super()}}
<script>
$(document).ready(function(){
    $('[data-toggle="popover"]').popover({'container': 'body', 'trigger': 'click', 'placement': 'right'});
});
</script>
{% endblock %}

{% block page_content %}
	<div class="monitor">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="form-heading">
				{% if configuration %}
					Current configuration '{{configuration.name}}'&nbsp;-&nbsp;
					{% if configuration.active %}
						Active
					{% else %}
						Not Active
					{% endif %}
				{% else %}
					No current configuration
				{% endif %}
				</h3>
			</div>
			<div class="panel-body">
			{% if configuration %}
				{% if current_user.is_alarm_setter() %}
					{% if configuration.active %}
				<a	class="btn btn-primary" role="button" 
					href="{{ url_for('monitor.deactivate_config') }}"
					onclick="return window.confirm('Are you sure you want to deactivate the alarm system?');">
					Deactivate
				</a>
					{% else %}
				<a	class="btn btn-primary" role="button" 
					href="{{ url_for('monitor.activate_config') }}"
					onclick="return window.confirm('Are you sure you want to activate the alarm system?');">
					Activate
				</a>
					{% endif %}
				{% endif %}
				{% if configuration.active %}
				{% endif %}
				<div class="monitor-tabs" role="tablist">
					<ul class="nav nav-tabs" role="tablist">
						<li role="presentation" class="active">
							<a href="#map" aria-controls="map" role="tab" data-toggle="tab">Map</a>
						</li>
						<li role="presentation">
							<a href="#alerts" aria-controls="alerts" role="tab" data-toggle="tab">Alerts</a>
						</li>
					</ul>
					<div class="tab-content">
						<div role="tabpanel" class="tab-pane active" id="map">
							{# TODO How to implement "realtime" update of devices tooltips? #}
							<div class="monitor-map-area">
								{{ svg_map|safe }}
							</div>
						</div>
						<div role="tabpanel" class="tab-pane" id="alerts">
							<div class="form-alert-filter">
							{# TODO improve rendering to show labels inside input fields... #}
							{# TODO improve CSS style #}
								<form class="form form-inline" method="post" role="form">
									{{ filter_form.hidden_tag() }}
									{{ wtf.form_errors(filter_form, hiddens = "only") }}
									{{ wtf.form_field(filter_form.period_from, 'inline', placeholder = 'From') }}
									{{ wtf.form_field(filter_form.period_to, 'inline', placeholder = 'To') }}
									{{ wtf.form_field(filter_form.alert_level, 'inline') }}
									{{ wtf.form_field(filter_form.alert_type, 'inline') }}
									{{ wtf.form_field(filter_form.submit, 'inline', button_map = {'alert_filter_submit': 'primary'}) }}
								</form>
							</div>
						
						{# TODO How to implement "realtime" refresh of alerts? #}
							<table class="alerts-list table table-striped table-condensed table-hover">
								<thead>
									<tr>
										<th>Level</th>
										<th>Time</th>
										<th>Type</th>
										<th>Module</th>
										<th>Message</th>
									</tr>
								</thead>
								<tbody>
								{% for alert in alerts %}
									<tr>
										<td>{{ utils.render_alert_level(alert) }}</td>
										<td>{{ alert.when.strftime('%d.%m.%Y %H:%M:%S') }}</td>
										<td>{{ utils.map_alert_type(alert) }}</td>
										<td>{{ alert.device.name }}</td>
										<td>{{ alert.message }}</td>
									</tr>
								{% endfor %}
								</tbody>
							</table>
						</div>
					</div>
				</div>
			{% endif %}
			</div>
		</div>
	</div>
{% endblock %}
